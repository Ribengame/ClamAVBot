#!/bin/bash
## ClamAVBot install script
## Prosty skrypt instalacyjny, wzorowany na przyk≈Çadzie Ree6

apt update
apt install -y jq curl git python3 python3-pip clamav clamav-daemon

CONFIG_LINK="https://raw.githubusercontent.com/Ribengame/ClamAVBot/main/config.json"

LATEST_JSON=$(curl --silent "https://api.github.com/repos/Ribengame/ClamAVBot/releases/latest")
RELEASES=$(curl --silent "https://api.github.com/repos/Ribengame/ClamAVBot/releases")
MATCH="clamavbot.zip"

if [ -z "${VERSION}" ] || [ "${VERSION}" == "latest" ]; then
    DOWNLOAD_URL=$(echo ${LATEST_JSON} | jq .assets | jq -r .[].browser_download_url | grep -i "${MATCH}" | head -1 )
else
    VERSION_CHECK=$(echo ${RELEASES} | jq -r --arg VERSION "${VERSION}" '.[] | select(.tag_name==$VERSION) | .tag_name')
    if [ "${VERSION}" == "${VERSION_CHECK}" ]; then
        DOWNLOAD_URL=$(echo ${RELEASES} | jq -r --arg VERSION "${VERSION}" '.[] | select(.tag_name==$VERSION) | .assets[].browser_download_url' | grep -i "${MATCH}" | head -1)
    else
        echo -e "defaulting to latest release"
        DOWNLOAD_URL=$(echo ${LATEST_JSON} | jq .assets | jq -r .[].browser_download_url | grep -i "${MATCH}")
    fi
fi

[ ! -d /mnt/server ] && mkdir -p /mnt/server

if [ ! -z "${DOWNLOAD_URL}" ]; then 
    if curl --output /dev/null --silent --head --fail ${DOWNLOAD_URL}; then
        echo -e "link is valid. setting download link to ${DOWNLOAD_URL}"
        DOWNLOAD_LINK=${DOWNLOAD_URL}
    else        
        echo -e "link is invalid closing out"
        exit 2
    fi
fi

cd /mnt/server
echo -e "\nInstalling/Updating ClamAVBot...\n"

if [ -f clamavbot.zip ]; then
    echo -e "Backing up old clamavbot.zip..."
    mv -f clamavbot.zip clamavbot.zip-old
fi

echo -e "Downloading ClamAVBot from ${DOWNLOAD_LINK}..."
curl -sSL -o clamavbot.zip ${DOWNLOAD_LINK}

echo -e "Extracting ClamAVBot..."
unzip -o clamavbot.zip -d /mnt/server

if [ -f config.json ]; then
    echo -e "Backing up old config.json..."
    mv -f config.json config.json-old
fi

echo -e "Downloading default config.json..."
curl -sSL -o config.json ${CONFIG_LINK}

echo -e "\nClamAVBot Successfully Installed!"
